function colorBar(){function a(a){a.each(function(a,k){function l(a,b){var c=document.createElementNS(d3.ns.prefix.svg,"path");c.setAttribute("d",a),q=c.getTotalLength();for(var d=[0],e=0,f=b;(e+=f)<q;)d.push(e);return d.push(q),d.map(function(a){var b=c.getPointAtLength(a),d=[b.x,b.y];return d.t=a/q,d})}function m(a){return d3.range(a.length-1).map(function(b){var c=[a[b-1],a[b],a[b+1],a[b+2]];return c.t=(a[b].t+a[b+1].t)/2,c})}function n(a,b,c,d,e){var f=p(b,c),g=e/2,h=[b[0]+f[0]*g,b[1]+f[1]*g],i=[c[0]+f[0]*g,c[1]+f[1]*g],j=[c[0]-f[0]*g,c[1]-f[1]*g],k=[b[0]-f[0]*g,b[1]-f[1]*g];if(a){var l=p(a,b),m=[b[0]+l[0]+f[0],b[1]+l[1]+f[1]];h=o(b,m,h,i),k=o(b,m,k,j)}if(d){var n=p(c,d),m=[c[0]+n[0]+f[0],c[1]+n[1]+f[1]];i=o(c,m,h,i),j=o(c,m,k,j)}return"M"+h+"L"+i+" "+j+" "+k+"Z"}function o(a,b,c,d){var e=c[0],f=a[0],g=d[0]-e,h=b[0]-f,i=c[1],j=a[1],k=d[1]-i,l=b[1]-j,m=(h*(i-j)-l*(e-f))/(l*g-h*k);return[e+m*g,i+m*k]}function p(a,b){var c=a[1]-b[1],d=b[0]-a[0],e=Math.sqrt(c*c+d*d);return[c/e,d/e]}var q,r=d3.select(this),s=c||e,t=b||("left"==d||"right"==d?[[0,f],[0,0]]:[[f,0],[0,0]]),u=m(l(i(t),j)),v=t?q:f,w=h.copy().interpolate(d3.interpolate).domain(h.domain()).range([v,0]),x=h.domain(),y=h.copy().domain(h.domain().map(function(a){return(a-x[0])/(x[1]-x[0])})),z=this.__lineWidth__||e;oldQuads=this.__quads__||u,this.__quads__=u,this.__lineWidth__=e;var A=r.selectAll("path.c").data(d3.range(u.length),function(a){return a}),B=A.enter().insert("path","g.axis").classed("c",!0),C=d3.transition(A.exit()).remove(),D=d3.transition(A),E=function(a,b,c){a.style("fill",function(a){return y(b(a).t)}).style("stroke",function(a){return y(b(a).t)}).attr("d",function(a){var d=b(a);return n(d[0],d[1],d[2],d[3],c)})};B.call(E,function(a){return oldQuads[oldQuads.length-1]},z),C.call(E,function(a){return u[u.length-1]},e),D.call(E,function(a){return u[a]},e);var F=d3.svg.axis().scale(w).orient(d).tickSize(s).tickFormat(g),G=r.selectAll("g.axis").data(function(a){return w?[1]:[]}),H=G.enter().append("g").classed("axis",!0),I=d3.transition(G.exit()).remove(),J=d3.transition(G).call(F),K=function(a,b){a.attr("transform","translate("+("right"==d||"left"==d?-b/2:0)+","+("right"==d||"left"==d?0:b/2)+")")};H.call(K,z),I.call(K,e),J.call(K,e)})}var b,c,d="right",e=40,f=300,g=d3.format("3e"),h=d3.scale.linear().domain([0,.5,1]).range(["blue","green","red"]),i=d3.svg.line().interpolate("basis"),j=8;return a.orient=function(b){return arguments.length?(d=b,a):d},a.lineWidth=function(b){return arguments.length?(e=b,a):e},a.size=function(b){return arguments.length?(f=b,a):f},a.tickFormat=function(b){return arguments.length?(g=b,a):g},a.tickSize=function(b){return arguments.length?(c=b,a):c},a.color=function(b){return arguments.length?(h=b,a):h},a.precision=function(b){return arguments.length?(j=b,a):j},a.points=function(c){return arguments.length?(b=c,a):b},a.line=function(b){return arguments.length?(i=b,a):i},a}angular.module("frontendApp",["oitozero.ngSweetAlert","angular.filter","colorpicker.module","picardy.fontawesome","mm.foundation","angulartics","angulartics.google.analytics","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/:dataset",{templateUrl:"views/tree.html",controller:"TreeController"}).otherwise({redirectTo:"/test"})}]),angular.module("frontendApp").controller("NavController",["$scope","$modal","dataService","SweetAlert",function(a,b,c,d){a.dataService=c,a.currentSearch="",a.getInfo=function(a,b){a.stopPropagation(),d.swal({title:b,html:c.metadata[b],allowOutsideClick:!0})},a.select=function(a){c.model.selected=a,console.log(c.model.selected)},a.openInfo=function(){b.open({templateUrl:"views/info.html",controller:"InfoCtrl"})}}]),angular.module("frontendApp").directive("chemTree",function(){function a(a,b){function c(a){function b(a){return a.children&&(a.r=a.children.reduce(function(a,c){return a+b(c)},0)),c.push(a),a.r}var c=[];return a.r=b(a),c}function d(){o.attr("x1",function(a){return e(a.source.x)}).attr("y1",function(a){return f(a.source.y)}).attr("x2",function(a){return e(a.target.x)}).attr("y2",function(a){return f(a.target.y)}),p.attr("cx",function(a){return e(a.x)}).attr("cy",function(a){return f(a.y)})}var e,f,g,h,i,j,k,l,m,n,o,p,q=b[0],r=d3.select(q).append("svg").attr({"class":"viz"});r.on("click",function(){d3.event.defaultPrevented||(a.selected=null,a.$apply())});var s=r.append("g");d3.selectAll(".viz").append("g").append("svg").attr("x","60").attr("y","100").append("g").attr("transform","translate(0, 10)").classed("colorbarA",!0),d3.selectAll(".viz").append("g").append("svg").attr("x","20").attr("y","100").append("g").attr("transform","translate(0, 10)").classed("colorbarB",!0),g=d3.scale.linear().domain([4,9]).clamp(!0).range(["hsl(300,80%,50%)","hsl(0,80%,50%)"]).interpolate(d3.interpolateString),i=d3.scale.linear().domain([5,-5]).clamp(!0).range(["hsl(300,80%,50%)","hsl(0,80%,50%)"]).interpolate(d3.interpolateString),j=d3.scale.linear().domain([0,.5]).clamp(!0).range(["hsl(300,80%,50%)","hsl(0,80%,50%)"]).interpolate(d3.interpolateString),a.$watch("treeType",function(b){function q(a){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragged",!0)}function t(a){var b=d3.mouse(s.node());a.x=e.invert(b[0]),a.y=f.invert(b[1]),d()}function u(a){d3.select(this).classed("dragging",!1),n.resume()}function v(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null),x()}function w(b){return"B"!==b.name[0]?v(b):void(d3.event.defaultPrevented||(d3.event.preventDefault(),b===a.selected?a.selected=null:a.selected=a.data.compounds[parseInt(b.name.substring(1))],n.start(),a.$apply()))}function x(){var a=c(B),b=d3.layout.tree().links(a);p=s.selectAll("circle").data(a,function(a){return a.name}),p.enter().append("svg:circle").attr("class","node").attr("cx",function(a){return e(a.x)}).attr("cy",function(a){return f(a.y)}).attr("r",function(a){return a.children?2:m(a.r)}).style("fill",h).style("stroke",l).style("stroke-width",function(a){return a.strokeWidth}).on("click",w).call(E).append("svg:title").text(function(a){return a.name}),p.attr("cx",function(a){return e(a.x)}).attr("cy",function(a){return f(a.y)}).attr("r",function(a){return a.children?2:m(a.r)}),p.exit().remove(),o=s.selectAll("line").data(b,function(a){return a.target.name}),o.attr("x1",function(a){return e(a.source.x)}).attr("y1",function(a){return f(a.source.y)}).attr("x2",function(a){return e(a.target.x)}).attr("y2",function(a){return f(a.target.y)}),o.enter().insert("svg:line",".node").attr("class","link").attr("x1",function(a){return e(a.source.x)}).attr("y1",function(a){return f(a.source.y)}).attr("x2",function(a){return e(a.target.x)}).attr("y2",function(a){return f(a.target.y)}).style("stroke","#D3D3D3").style("stroke-width","5px"),o.exit().remove()}function y(){d()}if(void 0!==a.treeType&&void 0!==a.data){console.log("test");var z,A,w,x,B=a.data.trees[a.treeType],C=c(B);d3.layout.tree().links(C);n=a.data.forces[a.treeType],e=d3.scale.linear().domain(d3.extent(C,function(a){return a.x})).range([.1*window.innerWidth,.9*window.innerWidth]),f=d3.scale.linear().domain(d3.extent(C,function(a){return a.y})).range([.1*window.innerHeight,.9*window.innerHeight]),m=d3.scale.linear().domain(d3.extent(C,function(a){return a.r})).range([4,10]);var D=colorBar().color(g).size(350).lineWidth(20).precision(4).tickFormat(d3.format("g"));d3.select(".colorbarA").call(D),"SLogP"===a.circleBorderType?(k=i,A=colorBar().color(k).size(350).lineWidth(20).precision(4).tickFormat(d3.format("g"))):"Lig_Eff"===a.circleBorderType?(k=j,A=colorBar().color(k).size(350).lineWidth(20).precision(4).tickFormat(d3.format("g"))):(z=d3.extent(C,function(a){return"B"===a.name[0]?a.stroke:void 0}),k=d3.scale.linear().domain([z[0],d3.mean(z),z[1]]).range(["#008000","#FFFF00","#FF0000"])),"None"===a.circleBorderType?d3.select(".colorbarB").style("visibility","hidden"):d3.select(".colorbarB").style("visibility","visible").call(A),h=function(a){return a._children?"#3182bd":a.children?"#D3D3D3":g(a.fill)},l=function(a){return a._children?"#CCC":a.children?"#D3D3D3":k(a.stroke)};var E=d3.behavior.drag().origin(function(a){return a}).on("dragstart",q).on("drag",t).on("dragend",u);x();var F=d3.behavior.zoom().scaleExtent([.1,10]).on("zoom",y);F.x(e).y(f),r.call(F),n.on("tick",d),console.log(n.size())}}),a.$watch("circleSizeType",function(b){if(void 0!==b&&void 0!==a.data){var d=a.data.trees[a.treeType],e=c(d);p=s.selectAll("circle").data(e,function(a){return a.name});var f=d3.extent(e,function(a){return"B"===a.name[0]?a.r:void 0}),g=4,h=d3.scale.linear().domain(f).range([g,10]);p.filter(function(a){return"B"===a.name[0]?this:null}).transition().delay(100).duration(750).attr("r",function(a){return f[0]==f[1]?g:h(a.r)})}}),a.$watch("circleBorderType",function(b){if(void 0!==b&&void 0!==a.data){var d,e,f,g;d=a.data.trees[a.treeType],e=c(d),p=s.selectAll("circle").data(e,function(a){return a.name}),"SLogP"===a.circleBorderType?(k=i,g=colorBar().color(k).size(350).lineWidth(20).precision(4).tickFormat(d3.format("g"))):"Lig_Eff"===a.circleBorderType?(k=j,g=colorBar().color(k).size(350).lineWidth(20).precision(4).tickFormat(d3.format("g"))):(f=d3.extent(e,function(a){return"B"===a.name[0]?a.stroke:void 0}),k=d3.scale.linear().domain([f[0],d3.mean(f),f[1]]).range(["#008000","#FFFF00","#FF0000"])),"None"===b?d3.select(".colorbarB").style("visibility","hidden"):d3.select(".colorbarB").style("visibility","visible").call(g),p.filter(function(a){return"B"===a.name[0]?this:null}).transition().delay(100).duration(750).style("stroke",function(a){return k(a.stroke)}).style("stroke-width",function(a){return a.strokeWidth})}}),a.$watch("activityType",function(b){if(void 0!==b&&void 0!==a.data){var d=a.data.trees[a.treeType],e=c(d);p=s.selectAll("circle").data(e,function(a){return a.name}),p.filter(function(a){return"B"===a.name[0]?this:null}).transition().delay(100).duration(750).style("fill",function(a){return g(a.fill)})}}),a.$watch("gravityValue",function(b){if(void 0!==b&&void 0!==a.data){var c=a.data.forces[a.treeType];c.resume(),c.gravity(b)}}),a.$watch("linkStrengthValue",function(b){if(void 0!==b&&void 0!==a.data){console.log("new linkStrength:"+b);var c=a.data.forces[a.treeType];c.linkStrength(b),c.resume(),a.$apply(),console.log("tree type is: ",a.treeType),console.log("setted linkStrength:"+c.linkStrength())}}),a.$watch("selected",function(b){void 0!==b&&void 0!==a.data&&(null===b?p.filter(function(a){return"B"===a.name[0]?this:null}).style("fill",function(a){return g(a.fill)}):p.filter(function(a){return"B"===a.name[0]?this:null}).style("fill",function(a){return a.name===b.id?"black":g(a.fill)}))})}return{restrict:"E",link:a,scope:{data:"=",current:"=",gravityValue:"=",linkStrengthValue:"=",treeType:"=",circleSizeType:"=",circleBorderType:"=",activityType:"=",selected:"="}}}),angular.module("frontendApp").factory("dataService",["$http","$q",function(a,b){var c={};c.model={selected:null},c.data=null,c.available={treeTypes:[],circleSizeTypes:["None"],circleBorderTypes:["None"],activityTypes:[]},c.current={treeType:null,circleSizeType:null,circleBorderType:null,activityType:null};c.flatten=function(a){function b(a){return a.children&&(a.r=a.children.reduce(function(a,c){return a+b(c)},0)),c.push(a),a.size}var c=[];return a.size=b(a),c},c.setTreeType=function(a){console.log("Set Tree to "+a),c.current.treeType=a,this.setActivityType(this.current.activityType)},c.setCircleSizeType=function(a){console.log("Set circle size:"+a),this.current.circleSizeType=a;var b=this.data.trees[this.current.treeType],d=c.flatten(b);"None"===a?d.forEach(function(a){a.r=2}):d.forEach(function(b){b.name.startsWith("B")&&(b.r=c.data.compounds[parseInt(b.name.substring(1))].properties[a])})},c.setCircleBorderType=function(a){console.log("Set circleBorderType:",a),c.current.circleBorderType=a;var b=this.data.trees[this.current.treeType],d=c.flatten(b);"None"===a?d.forEach(function(a){a.stroke=0,a.strokeWidth=0}):d.forEach(function(b){b.name.startsWith("B")&&(b.stroke=c.data.compounds[parseInt(b.name.substring(1))].properties[a],b.strokeWidth=3)})},c.setActivityType=function(a){console.log("Set activity type:",a),c.current.activityType=a;var b=this.data.trees[this.current.treeType],d=c.flatten(b);d.forEach(function(b){b.name.startsWith("B")&&(b.fill=c.data.compounds[parseInt(b.name.substring(1))].activities[a])})},c.empty=function(){return this.available.treeTypes.length=0,this.available.circleSizeTypes=["None"],this.available.circleBorderTypes=["None"],this.available.activityTypes.length=0,this.current.treeType=null,this.current.circleSizeType=null,this.current.circleBorderType=null,this.current.activityType=null,this},c.initializeData=function(){return this.empty(),this.metadata={},this.data.metadata.treeTypes.forEach(function(a){c.metadata[a.name]=a.metadata,c.available.treeTypes.push(a.name)}),this.setTreeType(this.available.treeTypes[0]),this.data.metadata.circleSizeTypes.forEach(function(a){c.metadata[a.name]=a.metadata,c.available.circleSizeTypes.push(a.name)}),this.setCircleSizeType(this.available.circleSizeTypes[0]),this.data.metadata.circleBorderTypes.forEach(function(a){c.metadata[a.name]=a.metadata,c.available.circleBorderTypes.push(a.name)}),this.setCircleBorderType(this.available.circleBorderTypes[0]),this.data.metadata.activityTypes.forEach(function(a){c.metadata[a.name]=a.metadata,c.available.activityTypes.push(a.name)}),this.setActivityType(this.available.activityTypes[0]),this};var d=d3.scale.linear().domain([0,.5]).range([5,100]),e=function(a){return d(Number(a.target.dist))};return c.loadExample=function(d,f){var g=b.defer();return a.get("data/"+d+".json").then(function(a){c.datasetName=d,c.data=a.data;var b=a.data.trees[a.data.metadata.treeTypes[0].name],f=c.flatten(b),h=d3.layout.tree().links(f),i={},j=0;for(j=0;j<a.data.metadata.treeTypes.length;j++){var k=d3.layout.force().charge(function(a){return a._children?100*-a.size:-50}).linkDistance(e).size([.7*window.innerWidth/2,window.innerHeight/2]);b=a.data.trees[a.data.metadata.treeTypes[j].name],f=c.flatten(b),h=d3.layout.tree().links(f),k.nodes(f).links(h),i[a.data.metadata.treeTypes[j].name]=k}return c.data.forces=i,c.data.force=i[a.data.metadata.treeTypes[0].name],c.initializeData(),g.resolve(a)}).then(f),g.promise},c}]),angular.module("frontendApp").controller("TreeController",["$scope","$routeParams","dataService",function(a,b,c){a.datasetName=b.dataset,a.model=c.model,a.current=c.current,a.flatten=c.flatten,a.tooltip={visibility:!1},a.$watch("tooltip.visibility",function(b){b===!1&&(a.model.selected=null)}),a.select=function(b){a.model.selected=b},a.$watch("model.selected",function(b){if(console.log("selected:",b),null===b)a.tooltip.visibility=!1;else{a.tooltip.visibility=!0;var c=b;a.tooltip.data={compound:!0,object:c}}}),a.gravitySlider={min:0,max:.2,value:.1,id:"gravity",name:"Radius of Display",leftName:"Lager",rightName:"Smaller"},a.linkStrengthSlider={min:0,max:10,value:1,id:"linkstrength",name:"Compactness",leftName:"Looser",rightName:"Tight"},c.loadExample(b.dataset,function(){a.data=c.data})}]),angular.module("frontendApp").directive("tooltips",["dataService",function(a){return{scope:{visibility:"=",data:"=",height:"@",click:"="},templateUrl:"views/tooltip.html",restrict:"E",link:function(b,c){var d=$(c[0]);b.dataService=a,b.close=function(){b.visibility=!1},b.$watch("visibility",function(a){a?d.show(400):d.hide(400)})}}}]),angular.module("frontendApp").directive("treeSlider",function(){return{scope:{min:"=",max:"=",value:"=",leftName:"=",rightName:"=",name:"=",id:"="},templateUrl:"views/tree-slider.html",restrict:"E",link:function(a,b){var c=$('<div class="name section"></div>'),d=$('<div class="left section"></div>'),e=$('<span class="sm-label">left</span>'),f=$('<div class="right section"></div>'),g=$('<span class="sm-label">right</span>'),h=$('<div class="slider"></div>'),i=b.find("div");$(i).append([c,h]);d3.scale.linear().domain([a.min,a.max]).range([0,280]);h.append([d,f]),g.appendTo(f),e.appendTo(d),c.text(a.name),g.text(a.rightName),e.text(a.leftName),h.slider({min:a.min,max:a.max,step:.01,value:a.value,slide:function(b,c){a.value=c.value,a.$apply()}})}}}),angular.module("frontendApp").controller("InfoCtrl",["$scope","$modalInstance",function(a,b){a.dismiss=function(){b.dismiss("cancel")}}]);